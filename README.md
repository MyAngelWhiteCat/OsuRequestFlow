[Общая архитектура модулей системы](Design.png)

# TODO
- HTTP-loopback server
- FileManager
- Core
- GUI

# In work
- Downloader
- HTTP Client
- FileManager

# Pre tested

# Ready
- IRC Client

# Tested

# Prod ver


---

## Current Progress

75-80%

---

## Current Task 
- Парсинг ссылок


---


## Task Board

### Main
- Разбить цели в CMakeLists на отдельные библиотеки
- Разбить все файлы на заголовки и реализации

### IRC Client
 - [Always] Рефакторинг. Анализ багов. Написать тесты.
 - Сделать авторизацию OAuth 2.0 flow взаимодействующую с GUI
 - полный переход Connetion на ассинхронные операции.
 - сделать ассинхронное подключение
 - Проверка соединения.
 - Тестирование.
 - вынести реализацию Connection за его объявление
 - сделать ассинхронную запись
 - доделать парсинг бейджей пользователя. 
 - сделать тайминги переподключения.
 - реализововать парсинг сообщений пользователей.
 - реализовать парсер-валидатор ссылок на карты osu возврат optional. 

### Downloader
- реализовать хэндлер ответа:
   - успех = записываем байты на диск. Неудача = информируем об ошибке.
 
- Обработать ошибку записи на диск. 
  Сделать ее потокобезопастной. 
  Сделать пул клиентов, через которые будет происходить взаимодействие с сервером.  
  Если клиент занят и есть место в пуле то создаем нового 
  Если все клиенты заняты и места нет то нужно придумать как заставить поток ждать освобождения.
  Можно сделать лямбду в пост которая будет переодически вызывать метод загрузки
- Обработка редиректов
- ConnectionPool, RequestBuilder, ResponseParser, ErrorHandler


### HTTP-loopback server
- Проектирование класса сервера, продумыть вспомогательные классы.
  - Какие нужны эндпоинты?
  - Что будет обрабатывать запросы? RequestHandler
  - Какие будут ответы? (Для фронта)
- Эндпоинты:
- Основа:
   - ник для подключения к чату.
   - авторизация через твич
   - путь к директории osu
   - скачивать сразу / просить подтверждение / игнорировать - все чаттеры / белый список / бан лист
   - включение / отключение
- Оптимизация: 
   - таймер реконнекта
   - выбрать количество рабочих потоков 1 или 2 (требуется перезапуск)
 
### FileManager
- Реализовать отдачу итераторов для произвольного удаления. Придумать как их хранить чтобы взаимодействовать с фронтом.
- создать защиту для дубликатов.

### Core
- Проектирование
- Объединение всего функционала в одну систему
- Какой будет порядок?

### GUI
- Андрюха разберется.

---

## Тестирование
- Наверное Макс разберется
- Исправить подсветку ошибок. Не подствечивает отсутсвуюшие символы.
- отрефакторить весь код вывода векторов.

---

## Выполненные задачи

### Main
- Сбор и анализ требований к системе
- Собрать видиние системы
- Продумать внешние зависимости
- Проектирование модулей системы
- Создание таргетов для тестов в CMakeLists
- Разбить CMakeLists таргеты на библиотеки


### IRC Client
- Проектирование
- Считать сообщение с сокета
- Понять как его парсить
- реализовать простой парсер
- Создать класс IRC клиент для чтения запросов
- придумать как сделать полиморфизм SSL | noSSL
- Изменить socket_ и ssl_socket_ на std::variant в Client
- Добавить ConnectionVisitor
- Отрефакторить ConnectionVisitor. Редактировать Client::Connect
- Добавить PingPongVisitor. Visitors сделать приватной частью Client
- Добавить ReadMessageVisitor. Редактировать Client::Read, Client::Connect, Client::Pong
- Отрефакторить MessageTypeIdentificator (итерация 1)
- Отрефакторить MessageTypeIdentificator (итерация 2)
- Отрефакторить MessageTypeIdentificator (итерация 3)
- Добавить JoinVisitor. Редактировать Client::Join
- Добавить AuthorizeVisitor. Редактировать Client::Authorize
- Добавить CapReqVisitor. Редактировать Client::CapRequest
- Перенести реализацию методов visitor классов в irc.cpp
- Добавить ca_sertificates_loader для загрузки CA сертификатов
- Добавить тестовые функции в main.cpp (Multichat)
- Исправить выброс str<Null>. Добавить больше тестовых функций (Multichat). Редактировать destructor Client -> Parting каналов, disconnect
- Добавить PartVisitor и создать Client::Part метод
- Проверить main
- Новая архитектура: Client теперь подкласс enable_shared_from_this. Client::Read() теперь асинхронный. Система делает первые шаги к полной асинхронной реализации
- Исправить проблему с CRLF путем эмуляции того, что boost::asio::async_read должен был делать
- [Откат коммита][Приоритетно] Понять насколько сильно повлияли измения связанные с попыткой внедрения классов-друзей для тестирования
- [Изменено]Внедрить и spdlog, для логгирования и nlohmanjson для сериализации данных (для фронта)
- Придумать как разбить класс Client на подклассы, пока он не разросся до безумия.
- Вынести методы работы с сырым сообщением из клиента в отдельный класс MessageProcessor
- [PRIORITET] фикс парсинга сообщений - все логи готовы. Добавить БАЗОВУЮ обработку CAP ответов и STATUSCODE сообщений.
- Разделить message_processor на файлы заголовка и реализации.
- Вынести работу с подключением в отдельный класс Connetion. В клиенте оставить поле shared_ptr<Connection> connection_. В нем будет вся работа с сетью - асинхронное чтение и запись. Возврат сырых данных.
- Разбить Client на хедер и реализацию
- Разбить MessageHandler на хедер и реализацию
- Отравлять PONG на PING
- [prioritet] Настроить переподключение при обрыве соединения:
- 1) Удалить всю логику переподключения из Connection
- 2) Создать метод получения контекстов из сокетов.
- 3) В клиенте - Полчаем контекст. Разрушаем Connection. Создаем новый. Запускаем цикл подключения.
- пройти 1+ час аптайма.
 

### Downloader
- Проектирование класса загрузчика. вспомогательные классы не нужны.
  - Как передавать полученный результат в файловую систему? Класс FileManager
  - Какие хосты будут использоваться?
      - https://chimu.moe/d/
      - https://catboy.best/d/
- Сделать базу класс http клиента
- протестировать клиента
- сделать тестовую цель для загрузчика
- реализовать логику отправки запроса на карту через клиента


### HTTP-loopback server
*Пока нет выполненных задач*

### FileManager
- Проектирование
- реализовать метод записи байтов на диск. Функция принимает путь, формат файла и сами байты.
- реализовать цепочку записей. Сохранять пути ко всем записанным файлам. 
- реализовать удаление файлов.


### Core
*Пока нет выполненных задач*

### GUI
- Найти хороший референс.


---

## Тестирование
- Сделать CMake таргет тестов
- Написать главную логику тестов через одну функцию сравнения вектора ожидаемых сообщений с фактическим
- Супер быстро накидать функцию сравнения для тестов с выводом в поток и подсветкой ошибок.
- Тестирование


---

## Required
- conan2.*
- CMake

Если конан не настроен или его нет:

```
pip install conan
conan profile detect --force
```

Добавь conan в Path (Если путь скриптов pip еще туда не добавлен).

```
mkdir build && cd build
conan install .. --build=missing --output-folder=. -s build_type=Debug -s compiler.runtime=static
(при первом запуске может занять больше часа. Сборка библиотек Boost)
cmake .. --preset conan-default
cmake --build .
(Может быть очень много ворнингов. Это ок)
```
  
  
